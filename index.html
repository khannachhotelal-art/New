<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Helper AI - Gemini Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .glass-effect { backdrop-filter: blur(8px); background: rgba(255, 255, 255, 0.8); }
        .dark .glass-effect { background: rgba(31, 41, 55, 0.8); }
        
        /* Markdown Styling */
        .prose pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
        .prose code { font-family: monospace; background: rgba(0,0,0,0.1); padding: 0.2rem 0.4rem; border-radius: 0.25rem; }
        .dark .prose code { background: rgba(255,255,255,0.1); }
        
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .dark #loading { background: #111827; color: white; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200">

    <div id="loading">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
            <p class="font-medium">Initializing Helper AI...</p>
        </div>
    </div>

    <div id="app" class="flex min-h-screen relative overflow-hidden hidden">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transform -translate-x-full lg:translate-x-0 sidebar-transition flex flex-col">
            <div class="p-4 flex items-center justify-between">
                <button onclick="createNewChat()" class="flex items-center gap-2 px-4 py-2 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-200 rounded-full hover:bg-blue-200 transition-colors w-full font-medium">
                    <i class="fas fa-plus"></i> New Chat
                </button>
                <button onclick="toggleSidebar()" class="lg:hidden ml-2 p-2 text-gray-500"><i class="fas fa-times"></i></button>
            </div>

            <div id="chat-list" class="flex-1 overflow-y-auto px-2 space-y-1 no-scrollbar">
                </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
                <button onclick="toggleDarkMode()" class="flex items-center gap-3 w-full p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i> 
                    <span>Appearance</span>
                </button>
                <button onclick="openSettings()" class="flex items-center gap-3 w-full p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                    <i class="fas fa-cog"></i> <span>Settings</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col w-full lg:ml-72 relative min-h-screen">
            <header class="sticky top-0 z-30 flex items-center justify-between p-4 glass-effect border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 text-gray-600 dark:text-gray-300">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h1 id="current-chat-title" class="font-semibold truncate max-w-[200px]">New Chat</h1>
                </div>
                <div class="text-xs font-mono bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded" id="model-badge">
                    deepseek-r1
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-32 no-scrollbar">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-4 opacity-50 py-20">
                    <i class="fas fa-robot text-6xl text-blue-500"></i>
                    <h2 class="text-2xl font-bold">How can I help you today?</h2>
                    <p class="max-w-md">Enter your API key in settings to start chatting with DeepSeek or other models via OpenRouter.</p>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 right-0 lg:left-72 p-4 bg-gradient-to-t from-gray-50 via-gray-50 to-transparent dark:from-gray-900 dark:via-gray-900">
                <div class="max-w-4xl mx-auto relative">
                    <div class="relative flex items-end bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-2 focus-within:ring-2 ring-blue-500 transition-all">
                        <textarea id="user-input" rows="1" placeholder="Type a message..." class="w-full bg-transparent border-none focus:ring-0 resize-none p-3 max-h-40 no-scrollbar" oninput="autoResize(this)"></textarea>
                        <button id="send-btn" onclick="handleSendMessage()" class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <p class="text-[10px] text-center mt-2 text-gray-500">AI can make mistakes. Verify important info.</p>
                </div>
            </div>
        </main>

        <div id="settings-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 hidden p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md overflow-hidden shadow-2xl">
                <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                    <h3 class="text-xl font-bold">Settings</h3>
                    <button onclick="closeSettings()"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
                        <input type="password" id="api-key-input" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 focus:outline-none focus:ring-2 ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Preferred Model</label>
                        <input type="text" id="model-input" placeholder="deepseek/deepseek-r1:free" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">System Prompt</label>
                        <textarea id="system-prompt-input" rows="3" class="w-full p-2 rounded bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700"></textarea>
                    </div>
                    <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700">Save & Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * APP STATE & CONSTANTS
         */
        let state = {
            chats: JSON.parse(localStorage.getItem('chats') || '[]'),
            currentChatId: null,
            apiKey: localStorage.getItem('apiKey') || '',
            model: localStorage.getItem('model') || 'deepseek/deepseek-r1:free',
            systemPrompt: localStorage.getItem('systemPrompt') || 'You are a helpful, clever, and concise AI assistant.',
            isDarkMode: localStorage.getItem('darkMode') === 'true',
            isStreaming: false
        };

        const elements = {
            loading: document.getElementById('loading'),
            app: document.getElementById('app'),
            chatContainer: document.getElementById('chat-container'),
            chatList: document.getElementById('chat-list'),
            userInput: document.getElementById('user-input'),
            settingsModal: document.getElementById('settings-modal'),
            sidebar: document.getElementById('sidebar'),
            welcomeScreen: document.getElementById('welcome-screen'),
            chatTitle: document.getElementById('current-chat-title')
        };

        /**
         * INITIALIZATION
         */
        window.onload = () => {
            // Setup Theme
            if (state.isDarkMode) document.documentElement.classList.add('dark');
            
            // Render Initial Sidebar
            renderChatList();
            
            // Hide Loader
            setTimeout(() => {
                elements.loading.classList.add('hidden');
                elements.app.classList.remove('hidden');
            }, 500);

            // Handle Enter Key
            elements.userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
        };

        /**
         * CORE CHAT LOGIC
         */
        async function handleSendMessage() {
            const text = elements.userInput.value.trim();
            if (!text || state.isStreaming) return;
            if (!state.apiKey) {
                alert('Please add your OpenRouter API Key in Settings first.');
                return openSettings();
            }

            // Create new chat if none active
            if (!state.currentChatId) {
                const newChat = {
                    id: Date.now(),
                    title: text.substring(0, 30) + '...',
                    messages: []
                };
                state.chats.unshift(newChat);
                state.currentChatId = newChat.id;
            }

            const currentChat = state.chats.find(c => c.id === state.currentChatId);
            
            // Add User Message
            const userMsg = { role: 'user', content: text };
            currentChat.messages.push(userMsg);
            
            // UI Updates
            elements.userInput.value = '';
            elements.userInput.style.height = 'auto';
            renderMessages();
            renderChatList();

            // Prepare AI Message placeholder
            const aiMsgId = 'ai-' + Date.now();
            const aiMsg = { role: 'assistant', content: '', id: aiMsgId };
            currentChat.messages.push(aiMsg);
            
            const aiMsgDiv = appendMessageUI('assistant', '', aiMsgId);
            state.isStreaming = true;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: [
                            { role: "system", content: state.systemPrompt },
                            ...currentChat.messages.filter(m => m.role !== 'assistant' || m.content).slice(-10) // Context window
                        ],
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');
                    
                    for (const line of lines) {
                        const message = line.replace(/^data: /, '');
                        if (message === '[DONE]') break;
                        
                        try {
                            const parsed = JSON.parse(message);
                            const content = parsed.choices[0].delta.content || "";
                            fullContent += content;
                            
                            // Update UI and Object
                            aiMsg.content = fullContent;
                            aiMsgDiv.querySelector('.prose').innerHTML = marked.parse(fullContent);
                            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
                        } catch (e) {
                            console.error("Error parsing stream", e);
                        }
                    }
                }
            } catch (error) {
                aiMsg.content = "Error: " + error.message;
                aiMsgDiv.querySelector('.prose').innerHTML = "Failed to connect to API. Check your key and connection.";
            } finally {
                state.isStreaming = false;
                saveToStorage();
            }
        }

        /**
         * UI RENDERING
         */
        function renderMessages() {
            elements.chatContainer.innerHTML = '';
            elements.welcomeScreen.classList.add('hidden');
            
            const currentChat = state.chats.find(c => c.id === state.currentChatId);
            if (!currentChat || currentChat.messages.length === 0) {
                elements.welcomeScreen.classList.remove('hidden');
                elements.chatTitle.innerText = "New Chat";
                return;
            }

            elements.chatTitle.innerText = currentChat.title;
            currentChat.messages.forEach(msg => {
                appendMessageUI(msg.role, msg.content);
            });
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
        }

        function appendMessageUI(role, content, id = null) {
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            if (id) wrapper.id = id;

            const html = `
                <div class="max-w-[85%] md:max-w-[75%] p-4 rounded-2xl ${
                    role === 'user' 
                    ? 'bg-blue-600 text-white rounded-tr-none' 
                    : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-tl-none'
                }">
                    <div class="flex items-center gap-2 mb-1 opacity-70 text-[10px] uppercase tracking-widest font-bold">
                        <i class="fas ${role === 'user' ? 'fa-user' : 'fa-robot'}"></i>
                        ${role === 'user' ? 'You' : 'Helper AI'}
                    </div>
                    <div class="prose dark:prose-invert max-w-none text-sm leading-relaxed">
                        ${marked.parse(content || (role === 'assistant' ? '...' : ''))}
                    </div>
                </div>
            `;
            wrapper.innerHTML = html;
            elements.chatContainer.appendChild(wrapper);
            elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            return wrapper;
        }

        function renderChatList() {
            elements.chatList.innerHTML = '';
            state.chats.forEach(chat => {
                const btn = document.createElement('div');
                btn.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${state.currentChatId === chat.id ? 'bg-gray-200 dark:bg-gray-700' : 'hover:bg-gray-100 dark:hover:bg-gray-800'}`;
                btn.onclick = () => selectChat(chat.id);
                
                btn.innerHTML = `
                    <div class="flex items-center gap-3 truncate mr-2">
                        <i class="far fa-comment-alt opacity-50"></i>
                        <span class="truncate text-sm">${chat.title}</span>
                    </div>
                    <button onclick="deleteChat(event, ${chat.id})" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-opacity">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                `;
                elements.chatList.appendChild(btn);
            });
        }

        /**
         * ACTIONS
         */
        function selectChat(id) {
            state.currentChatId = id;
            renderMessages();
            renderChatList();
            if (window.innerWidth < 1024) toggleSidebar();
        }

        function createNewChat() {
            state.currentChatId = null;
            renderMessages();
            renderChatList();
            if (window.innerWidth < 1024) toggleSidebar();
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.currentChatId === id) state.currentChatId = null;
            saveToStorage();
            renderChatList();
            renderMessages();
        }

        function toggleSidebar() {
            elements.sidebar.classList.toggle('-translate-x-full');
        }

        function toggleDarkMode() {
            state.isDarkMode = !state.isDarkMode;
            document.documentElement.classList.toggle('dark');
            saveToStorage();
        }

        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('model-input').value = state.model;
            document.getElementById('system-prompt-input').value = state.systemPrompt;
            elements.settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            elements.settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value.trim();
            state.model = document.getElementById('model-input').value.trim() || 'deepseek/deepseek-r1:free';
            state.systemPrompt = document.getElementById('system-prompt-input').value.trim();
            document.getElementById('model-badge').innerText = state.model.split('/').pop();
            saveToStorage();
            closeSettings();
        }

        function saveToStorage() {
            localStorage.setItem('chats', JSON.stringify(state.chats));
            localStorage.setItem('apiKey', state.apiKey);
            localStorage.setItem('model', state.model);
            localStorage.setItem('systemPrompt', state.systemPrompt);
            localStorage.setItem('darkMode', state.isDarkMode);
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

    </script>
</body>
  </html>
