<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Helper AI - Your Smart Assistant</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  html, body { height: 100%; overflow: hidden; }
  #messages pre { background: #1f2937; color: #f9fafb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
  #messages code { font-family: 'Fira Code', monospace; font-size: 0.875rem; }
  .typing-cursor::after { content: "‚óè"; animation: blink 1s infinite; margin-left: 4px; color: #3b82f6; }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
  .chat-bubble { transition: all 0.2s ease-in-out; }
  /* Custom Scrollbar */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
  ::-webkit-scrollbar-thumb:hover { background: #555; }
</style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">

<div id="loading" class="flex items-center justify-center h-screen text-blue-500 font-bold animate-pulse">
  Initializing Helper AI...
</div>

<div id="app" class="hidden h-screen flex overflow-hidden text-gray-800 dark:text-gray-100">

  <aside id="sidebar"
    class="fixed md:static inset-y-0 left-0 w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transform -translate-x-full md:translate-x-0 transition-transform z-30 flex flex-col shadow-xl">

    <div class="p-5 border-b dark:border-gray-700 flex justify-between items-center bg-blue-600 text-white">
      <span class="font-bold text-lg tracking-tight">ü§ñ Helper AI</span>
      <button id="closeSidebar" class="md:hidden">‚úï</button>
    </div>

    <div class="p-4">
      <button id="newChatBtn"
        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-xl py-3 transition-all flex items-center justify-center gap-2 shadow-md">
        <span class="text-xl">+</span> New Conversation
      </button>
    </div>

    <div id="chatList" class="flex-1 overflow-y-auto px-3 space-y-2"></div>

    <div class="p-4 border-t dark:border-gray-700 grid grid-cols-2 gap-2">
      <button id="settingsBtn" class="p-2 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200">‚öô Settings</button>
      <button id="darkToggle" class="p-2 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200">üåì Theme</button>
    </div>
  </aside>

  <div class="flex-1 flex flex-col relative w-full overflow-hidden">

    <header class="flex items-center justify-between p-4 border-b dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm">
      <div class="flex items-center">
        <button id="openSidebar" class="md:hidden p-2 mr-2 bg-gray-100 dark:bg-gray-700 rounded-lg">‚ò∞</button>
        <h1 id="activeChatTitle" class="font-semibold text-gray-600 dark:text-gray-300">Current Session</h1>
      </div>
      <div class="text-xs text-green-500 font-mono hidden md:block">System Status: Online</div>
    </header>

    <main id="messages" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth"></main>

    <div class="p-4 bg-transparent">
      <div class="max-w-4xl mx-auto relative group">
        <div class="flex items-end gap-2 bg-white dark:bg-gray-800 p-2 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700">
          <textarea id="messageInput"
            rows="1"
            class="flex-1 max-h-48 resize-none bg-transparent p-3 text-base focus:outline-none"
            placeholder="Type your message to Helper AI..."></textarea>
          <button id="sendBtn"
            class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl transition-all shadow-lg disabled:opacity-50">
            <svg viewBox="0 0 24 24" class="w-5 h-5 fill-current"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
          </button>
        </div>
        <p class="text-[10px] text-center mt-2 text-gray-400">Helper AI can make mistakes. Verify important info.</p>
      </div>
    </div>

  </div>
</div>

<div id="settingsModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
  <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl scale-in">
    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">‚öô Configuration</h2>
    
    <div class="space-y-4">
      <div>
        <label class="text-xs font-bold uppercase text-gray-500">API Key</label>
        <input id="apiKeyInput" type="password" class="w-full border dark:border-gray-600 rounded-xl p-3 mt-1 bg-gray-50 dark:bg-gray-700 focus:ring-2 ring-blue-500 outline-none">
      </div>
      <div>
        <label class="text-xs font-bold uppercase text-gray-500">Model Endpoint</label>
        <input id="modelInput" type="text" class="w-full border dark:border-gray-600 rounded-xl p-3 mt-1 bg-gray-50 dark:bg-gray-700">
      </div>
      <div>
        <label class="text-xs font-bold uppercase text-gray-500">System Behavior</label>
        <textarea id="systemPromptInput" class="w-full border dark:border-gray-600 rounded-xl p-3 mt-1 bg-gray-50 dark:bg-gray-700 h-24"></textarea>
      </div>
    </div>

    <div class="flex justify-end gap-3 mt-6">
      <button id="closeSettings" class="px-5 py-2 rounded-lg font-medium">Cancel</button>
      <button id="saveSettings" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-blue-700">Apply Changes</button>
    </div>
  </div>
</div>

<script>
(function(){
/* ---------------- STATE ---------------- */
let chats = JSON.parse(localStorage.getItem("chats") || "[]");
let currentChatId = localStorage.getItem("currentChatId");
let apiKey = localStorage.getItem("apiKey") || "";
let model = localStorage.getItem("model") || "deepseek/deepseek-r1:free";
let darkMode = localStorage.getItem("darkMode") === "true";

/* ---------------- ELEMENTS ---------------- */
const elements = {
  loading: document.getElementById("loading"),
  app: document.getElementById("app"),
  chatList: document.getElementById("chatList"),
  messagesDiv: document.getElementById("messages"),
  input: document.getElementById("messageInput"),
  activeTitle: document.getElementById("activeChatTitle")
};

/* ---------------- INIT ---------------- */
function init(){
  if(darkMode) document.documentElement.classList.add("dark");
  if(!chats.length) createNewChat();
  renderChatList();
  selectChat(currentChatId || chats[0].id);
  
  elements.loading.classList.add("hidden");
  elements.app.classList.remove("hidden");
}

/* ---------------- CORE FUNCTIONS ---------------- */
function createNewChat(){
  const chat = {
    id: Date.now().toString(),
    name: "New Helper Chat",
    messages: [],
    systemPrompt: "You are Helper AI, a polite and smart assistant."
  };
  chats.unshift(chat);
  save();
  renderChatList();
  selectChat(chat.id);
}

function save(){
  localStorage.setItem("chats", JSON.stringify(chats));
  localStorage.setItem("currentChatId", currentChatId);
  localStorage.setItem("apiKey", apiKey);
  localStorage.setItem("model", model);
  localStorage.setItem("darkMode", darkMode);
}

function selectChat(id){
  currentChatId = id;
  const chat = chats.find(c => c.id === id);
  elements.activeTitle.textContent = chat ? chat.name : "Chat";
  renderChatList(); // To update active state UI
  renderMessages();
}

function renderChatList(){
  elements.chatList.innerHTML = "";
  chats.forEach(chat => {
    const isActive = chat.id === currentChatId;
    const btn = document.createElement("div");
    btn.className = `p-3 rounded-xl cursor-pointer flex justify-between items-center group transition-all ${isActive ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-600' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
    btn.innerHTML = `
      <span class="truncate text-sm font-medium">${chat.name}</span>
      <button onclick="event.stopPropagation(); deleteChat('${chat.id}')" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 px-2">‚úï</button>
    `;
    btn.onclick = () => selectChat(chat.id);
    elements.chatList.appendChild(btn);
  });
}

window.deleteChat = (id) => {
  chats = chats.filter(c => c.id !== id);
  if(chats.length === 0) createNewChat();
  else if(currentChatId === id) selectChat(chats[0].id);
  save();
  renderChatList();
};

function renderMessages(){
  elements.messagesDiv.innerHTML = "";
  const chat = chats.find(c => c.id === currentChatId);
  if(!chat) return;
  chat.messages.forEach(msg => addMessageToUI(msg.role, msg.content));
  scrollToBottom();
}

function addMessageToUI(role, content){
  const isUser = role === "user";
  const wrapper = document.createElement("div");
  wrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'} animate-fadeIn`;

  const bubble = document.createElement("div");
  bubble.className = `max-w-[85%] p-4 rounded-2xl shadow-sm ${isUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-tl-none text-gray-800 dark:text-gray-100'}`;
  
  bubble.innerHTML = `
    <div class="text-[10px] mb-1 font-bold uppercase tracking-widest opacity-70">${isUser ? 'You' : 'Helper AI'}</div>
    <div class="prose dark:prose-invert text-sm sm:text-base">${marked.parse(content)}</div>
  `;
  
  wrapper.appendChild(bubble);
  elements.messagesDiv.appendChild(wrapper);
}

async function sendMessage(){
  const text = elements.input.value.trim();
  if(!text || !apiKey) return !apiKey && alert("Please set your API Key in Settings!");

  const chat = chats.find(c => c.id === currentChatId);
  
  // Update UI & State
  if(chat.messages.length === 0) chat.name = text.substring(0, 20) + "...";
  chat.messages.push({role:"user", content:text});
  addMessageToUI("user", text);
  elements.input.value = "";
  elements.input.style.height = 'auto';
  save();
  renderChatList();
  scrollToBottom();

  // AI Placeholder
  const aiWrapper = document.createElement("div");
  aiWrapper.className = "flex justify-start";
  const aiBubble = document.createElement("div");
  aiBubble.className = "max-w-[85%] p-4 rounded-2xl bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-tl-none typing-cursor";
  aiBubble.innerHTML = `<div class="text-[10px] mb-1 font-bold uppercase opacity-70">Helper AI</div><div class="content text-sm sm:text-base italic">Thinking...</div>`;
  aiWrapper.appendChild(aiBubble);
  elements.messagesDiv.appendChild(aiWrapper);
  scrollToBottom();

  const contentDiv = aiBubble.querySelector(".content");

  try {
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + apiKey },
      body: JSON.stringify({
        model: model,
        stream: true,
        messages: [
          {role: "system", content: chat.systemPrompt},
          ...chat.messages
        ]
      })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullAiText = "";
    contentDiv.classList.remove("italic");
    contentDiv.innerHTML = "";

    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      const chunk = decoder.decode(value);
      const lines = chunk.split("\n");
      
      for(let line of lines){
        if(line.startsWith("data: ")){
          const jsonStr = line.replace("data: ","").trim();
          if(jsonStr === "[DONE]") break;
          try {
            const data = JSON.parse(jsonStr);
            const token = data.choices?.[0]?.delta?.content;
            if(token){
              fullAiText += token;
              contentDiv.innerHTML = marked.parse(fullAiText);
              scrollToBottom();
            }
          } catch(e){}
        }
      }
    }
    aiBubble.classList.remove("typing-cursor");
    chat.messages.push({role:"assistant", content:fullAiText});
    save();
  } catch(e) {
    contentDiv.innerHTML = "‚ö†Ô∏è Connection Error. Check API Key or Internet.";
  }
}

/* ---------------- HELPERS ---------------- */
function scrollToBottom() { elements.messagesDiv.scrollTop = elements.messagesDiv.scrollHeight; }

elements.input.addEventListener("input", function() {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});

elements.input.addEventListener("keydown", (e) => {
  if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

/* ---------------- UI CONTROLS ---------------- */
document.getElementById("newChatBtn").onclick = createNewChat;
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("darkToggle").onclick = () => {
  darkMode = !darkMode;
  document.documentElement.classList.toggle("dark");
  save();
};
document.getElementById("openSidebar").onclick = () => document.getElementById("sidebar").classList.remove("-translate-x-full");
document.getElementById("closeSidebar").onclick = () => document.getElementById("sidebar").classList.add("-translate-x-full");

// Settings Logic
document.getElementById("settingsBtn").onclick = () => {
  document.getElementById("settingsModal").classList.remove("hidden");
  document.getElementById("apiKeyInput").value = apiKey;
  document.getElementById("modelInput").value = model;
  document.getElementById("systemPromptInput").value = chats.find(c=>c.id === currentChatId).systemPrompt;
};
document.getElementById("saveSettings").onclick = () => {
  apiKey = document.getElementById("apiKeyInput").value;
  model = document.getElementById("modelInput").value;
  chats.find(c=>c.id === currentChatId).systemPrompt = document.getElementById("systemPromptInput").value;
  save();
  document.getElementById("settingsModal").classList.add("hidden");
};
document.getElementById("closeSettings").onclick = () => document.getElementById("settingsModal").classList.add("hidden");

init();
})();
</script>
</body>
</html>
